name: Update Plushie Buddies download count

on:
  schedule:
    # Every hour at minute 5 â€” tweak if you like
    - cron: "5 * * * *"
  workflow_dispatch: {}

jobs:
  update-downloads:
    runs-on: ubuntu-latest

    steps:
      - name: Check out repository
        uses: actions/checkout@v4

      - name: Set up Node
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Fetch download count from Shields.io
        run: |
          node << 'EOF'
          const https = require('https');
          const fs = require('fs');

          const url = 'https://img.shields.io/curseforge/dt/990265.json';

          https.get(url, res => {
            let body = '';
            res.on('data', chunk => (body += chunk));
            res.on('end', () => {
              if (res.statusCode !== 200) {
                console.error('Shields.io returned', res.statusCode, body);
                process.exit(1);
              }

              let json;
              try {
                json = JSON.parse(body);
              } catch (e) {
                console.error('Failed to parse JSON:', e);
                console.error(body);
                process.exit(1);
              }

              const message = json && json.message;
              if (typeof message !== 'string') {
                console.error('No "message" field found in Shields.io response:', json);
                process.exit(1);
              }

              // Try to turn the message ("12.3k", "1234", etc.) into a number
              function parseDownloadMessage(msg) {
                const trimmed = msg.trim().toLowerCase();
                const match = trimmed.match(/^([\d.,]+)\s*([kmb])?$/i);
                if (!match) {
                  const numeric = parseInt(trimmed.replace(/[^0-9]/g, ''), 10);
                  return Number.isFinite(numeric) ? numeric : null;
                }
                let num = parseFloat(match[1].replace(',', ''));
                if (!Number.isFinite(num)) return null;
                const suffix = match[2];
                if (suffix === 'k') num *= 1_000;
                else if (suffix === 'm') num *= 1_000_000;
                else if (suffix === 'b') num *= 1_000_000_000;
                return Math.round(num);
              }

              const approx = parseDownloadMessage(message);
              const now = new Date().toISOString();

              let existing = [];
              try {
                const raw = fs.readFileSync('download-data.json', 'utf8');
                const parsed = JSON.parse(raw);
                if (Array.isArray(parsed)) existing = parsed;
              } catch (_e) {
                // file may not exist yet, that's fine
              }

              existing.push({
                timestamp: now,
                downloadDisplay: message,  // e.g. "12.3k"
                downloadApprox: approx     // e.g. 12300 (approximate)
              });

              fs.writeFileSync(
                'download-data.json',
                JSON.stringify(existing, null, 2),
                'utf8'
              );

              console.log('Recorded downloads', message, 'approx', approx, 'at', now);
            });
          }).on('error', err => {
            console.error('HTTPS error:', err);
            process.exit(1);
          });
          EOF

      - name: Commit and push changes (if any)
        run: |
          if [[ -n "$(git status --porcelain)" ]]; then
            git config user.name "github-actions[bot]"
            git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
            git add download-data.json
            git commit -m "Update download count (Shields)"
            git push
          else
            echo "No changes to commit."
          fi
